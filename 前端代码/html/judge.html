<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
  <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
  <title>文档</title>
  <link rel="stylesheet" type="text/css" href="../css/api.css" />
  <link rel="stylesheet" type="text/css" href="../css/style.css" />
</head>

<body>
  <p>故障推理分析中，请稍候...</p>
</body>

</html>

<script>
  function getQueryParams() {
    const params = new URLSearchParams(window.location.search);
    return {
      brand: params.get('brand'),
      xinghao: params.get('xinghao'),
      errorid: params.get('errorid'),
      describe: params.get('describe')
    };
  }

  window.onload = function () {
    const { brand, xinghao, errorid, describe } = getQueryParams();
    let finalBrand = brand;
    if (finalBrand == "其他品牌" || finalBrand == "请选择品牌") {
      finalBrand = '';
    }

    const url = `http://127.0.0.1:8000/qa?pinpai=${finalBrand}&xinghao=${xinghao}&errorid=${errorid}&question=${describe}`;

    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(ret => {
        // 将大数据存储在 sessionStorage 中，避免 URL 过长
        const storageKey = 'qa_result_data_' + Date.now();
        sessionStorage.setItem(storageKey, JSON.stringify(ret));
        sessionStorage.setItem(storageKey + '_query', JSON.stringify({
          brand: brand,
          xinghao: xinghao,
          errorid: errorid,
          describe: describe
        }));

        // 根据后端返回的数据结构判断跳转到哪个页面
        if (ret.hasOwnProperty("selectedlist")) {
          // 只传递小的参数和存储键
          const params = new URLSearchParams({
            brand: brand,
            xinghao: xinghao,
            errorid: errorid,
            describe: describe,
            dataKey: storageKey  // 只传递存储键，不传递完整数据
          });
          const targetUrl = `./reason_result.html?${params.toString()}`;
          // 使用标准页面跳转
          window.location.href = targetUrl;
        } else {
          // 假设另一个结果页是 search_result.html
          const params = new URLSearchParams({
            brand: brand,
            xinghao: xinghao,
            errorid: errorid,
            describe: describe,
            dataKey: storageKey
          });
          const targetUrl = `./search_result.html?${params.toString()}`;
          window.location.href = targetUrl;
        }
      })
      .catch(err => {
        console.error('Fetch Error:', err);
        alert('抱歉，未检索到解决方案');
        // 可以在此处添加返回上一页或显示错误信息的逻辑
        history.back();
      });
  };
</script>