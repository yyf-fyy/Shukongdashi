# Web 迁移修复说明

## 问题：详情页面解决方案未显示

### 问题原因

1. **页面跳转方式问题**：`reason_result.html` 中使用了 `window.parent.navigateTo()`，这是非标准的导航方法，在 Web 环境中不存在
2. **数据传递问题**：URL 参数传递时，JSON 字符串被双重字符串化，导致解析失败
3. **错误处理缺失**：缺少数据解析失败的错误处理和提示

### 修复内容

#### 1. 修复 `reason_result.html` 中的页面跳转

**修改位置**：`html/reason_result.html`

- 将 `window.parent.navigateTo()` 改为标准的 `window.location.href`
- 添加了通过索引访问列表项的方式，避免在 HTML 属性中传递复杂对象
- 新增 `openDetailByIndex()` 函数，使用索引安全地打开详情页

```javascript
// 修复前
function openDetail(listObj1) {
    const params = new URLSearchParams({ listObj: listObj1 });
    const url = `html/answerReason_detail.html?${params.toString()}`;
    if (window.parent && window.parent.navigateTo) {
        window.parent.navigateTo(url);
    }
}

// 修复后
function openDetail(listObj1) {
    var listObjStr = typeof listObj1 === 'string' ? listObj1 : JSON.stringify(listObj1);
    var encodedListObj = encodeURIComponent(listObjStr);
    const url = `./answerReason_detail.html?listObj=${encodedListObj}`;
    window.location.href = url;
}

// 新增：通过索引打开详情页（更安全）
function openDetailByIndex(index) {
    if (!currentListData || !currentListData.list || !currentListData.list[index]) {
        console.error('列表数据不存在或索引无效');
        return;
    }
    var listItem = currentListData.list[index];
    var listObjStr = JSON.stringify(listItem);
    var encodedListObj = encodeURIComponent(listObjStr);
    const url = `./answerReason_detail.html?listObj=${encodedListObj}`;
    window.location.href = url;
}
```

#### 2. 修复 `answerReason_detail.html` 中的数据解析

**修改位置**：`html/answerReason_detail.html`

- 添加了完整的错误处理机制
- 修复了 URL 参数解码问题
- 添加了数据为空时的友好提示

```javascript
// 修复前
window.onload = function () {
    const { listObj } = getQueryParams();
    const data = JSON.parse(listObj);
    document.getElementById('question').innerHTML = data.yuanyin;
    document.getElementById('answer').innerHTML = data.answer;
};

// 修复后
window.onload = function () {
    try {
        const { listObj } = getQueryParams();
        
        if (!listObj) {
            console.error('缺少 listObj 参数');
            document.getElementById('question').innerHTML = '<p style="color:red;">数据加载失败：缺少参数</p>';
            return;
        }

        // 解码 URL 参数
        const decodedListObj = decodeURIComponent(listObj);
        const data = JSON.parse(decodedListObj);

        const questionContent = document.getElementById('question');
        const answerContent = document.getElementById('answer');
        
        // 显示原因
        if (data.yuanyin) {
            questionContent.innerHTML = data.yuanyin;
        } else {
            questionContent.innerHTML = '<p style="color:#999;">暂无原因描述</p>';
        }
        
        // 显示解决方案
        if (data.answer) {
            answerContent.innerHTML = data.answer;
        } else {
            answerContent.innerHTML = '<p style="color:#999;">暂无解决方案</p>';
        }
    } catch (error) {
        console.error('数据解析失败:', error);
        document.getElementById('question').innerHTML = '<p style="color:red;">数据解析失败：' + error.message + '</p>';
        document.getElementById('answer').innerHTML = '<p style="color:red;">请返回重试</p>';
    }
};
```

#### 3. 修复 HTML 中的 onclick 绑定

**修改位置**：`html/reason_result.html` 第 546 行

- 将直接传递 JSON 字符串改为使用索引
- 避免在 HTML 属性中出现复杂的 JSON 字符串

```javascript
// 修复前
var cl = '<li onclick=\'openDetail(' + JSON.stringify(listObj) + ')\'>';

// 修复后
var cl = '<li data-obj-index="' + i + '" onclick="openDetailByIndex(' + i + ')">';
```

### 测试建议

1. **测试数据传递**：
   - 打开原因结果页面
   - 点击列表项，检查是否能正确跳转到详情页
   - 检查详情页是否显示了"可能的原因"和"解决方案"

2. **测试错误处理**：
   - 手动修改 URL 参数，使其无效
   - 检查是否正确显示错误提示

3. **测试边界情况**：
   - 测试数据为空的情况
   - 测试数据格式不正确的情况

### 相关文件

- `html/reason_result.html` - 原因结果列表页
- `html/answerReason_detail.html` - 详情页面

### 注意事项

1. 所有页面跳转现在都使用标准的 `window.location.href`
2. URL 参数中的 JSON 数据使用 `encodeURIComponent` 进行编码
3. 在详情页中使用 `decodeURIComponent` 进行解码
4. 添加了完整的错误处理，避免页面崩溃


